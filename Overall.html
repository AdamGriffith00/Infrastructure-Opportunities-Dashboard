<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infrastructure Hub</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f3f3f3; color: #222;
    }
    /* Tabs */
    .tab-container {
      display: flex; flex-wrap: wrap;
      background: rgb(247,196,0); /* Gleeds yellow */
    }
    .tab {
      flex: 1 1 50%; text-align: center; padding: 1em;
      cursor: pointer; background: rgb(247,196,0); color: #fff;
      border-bottom: 2px solid transparent; transition: background .25s;
      user-select: none;
    }
    .tab:hover, .tab.active { background: rgb(60,60,60); } /* charcoal */
    .tab-content { display: none; padding: 1em; background: #fff; }
    .tab-content.active { display: block; }
    @media (min-width: 768px){ .tab { flex: 1 1 20%; } }

    /* Iframes for other tabs */
    iframe { width: 100%; height: 90vh; border: none; background: #fff; }

    /* Live Opportunities */
    .live-wrap { max-width: 1200px; margin: 0 auto; }
    .live-header { display:flex; align-items:baseline; gap:1rem; flex-wrap:wrap; margin-bottom:.5rem; }
    .live-title { font-size:1.75rem; font-weight:700; margin:0; }
    .last-updated { color:#555; font-size:.95rem; }
    .error { color:#b00020; margin:.5rem 0 0; font-weight:600; }

    /* Filter bar */
    .filter-bar {
      display:flex; flex-wrap:wrap; gap:.5rem; margin:.5rem 0 1rem;
    }
    .filter-pill {
      border:1px solid #ddd; background:#fff; color:#333;
      padding:.35rem .6rem; border-radius:999px; font-size:.9rem; cursor:pointer;
      user-select:none;
    }
    .filter-pill.active { background: rgb(60,60,60); color:#fff; border-color: rgb(60,60,60); }

    /* Table container (mobile scroll) */
    .table-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid #e5e5e5; border-radius:8px; background:#fff; }
    table { width:100%; border-collapse:collapse; min-width:900px; }
    thead th {
      position:sticky; top:0; background:#f8f8f8; z-index:1;
      text-align:left; padding:10px 12px; font-weight:700; border-bottom:1px solid #e5e5e5; white-space:nowrap;
    }
    tbody td { padding:10px 12px; border-bottom:1px solid #eee; vertical-align:top; }
    tbody tr:hover { background:#fafafa; }
    a.title-link { color:#0b63ce; text-decoration:none; }
    a.title-link:hover { text-decoration:underline; }

    .pill {
      display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; line-height:1.6;
      background:#eef2f7; color:#333; white-space:nowrap;
    }
    /* sector tints */
    .pill.aviation{background:#e8f2ff;}
    .pill.utilities{background:#efeaff;}
    .pill.rail{background:#eaf7ee;}
    .pill.highways{background:#fff4e5;}
    .pill.maritime{background:#e9f7fa;}
    .pill.infrastructure{background:#f1f3f5;}

    .muted { color:#666; font-size:.9rem; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <!-- Top tabs -->
  <div class="tab-container">
  <div class="tab active" data-tab="budget-summary">2025/26 Budget Summary</div>
  <div class="tab" data-tab="regions">Regions - 2025/26 Projects</div>
  <div class="tab" data-tab="ten-year-budget">10 Year Budget Summary</div>
  <div class="tab" data-tab="frameworks">Frameworks</div>  <!-- moved here -->
  <div class="tab" data-tab="gleeds-pipeline">Gleeds Pipeline</div>
  <div class="tab" data-tab="live">Live Opportunities</div>
</div>
  
  <!-- Tab bodies -->
  <div class="tab-content active" id="budget-summary">
    <iframe src="budget-summary.html" title="Budget Summary"></iframe>
  </div>

  <div class="tab-content" id="regions">
    <iframe src="uk-map.html" title="Regions"></iframe>
  </div>
  
  <div class="tab-content" id="ten-year-budget">
    <iframe src="uk-interactive-map-10-year.html" title="Regions"></iframe>
  </div>

  <div class="tab-content" id="gleeds-pipeline">
    <p>Content for Gleeds Pipeline will go here.</p>
  </div>

  <!-- LIVE OPPORTUNITIES -->
  <div class="tab-content" id="live">
    <div class="live-wrap">
      <div class="live-header">
        <h2 class="live-title">Live Opportunities</h2>
        <div class="last-updated" id="lastUpdated">Last updated: —</div>
      </div>
      <div id="liveError" class="error" style="display:none;"></div>

      <!-- Sector filters -->
      <div class="filter-bar" id="filterBar">
        <!-- pills injected -->
      </div>

      <div class="table-scroll">
        <table id="liveTable">
          <thead>
            <tr>
              <th>Title</th>
              <th>Buyer</th>
              <th>Region</th>
              <th>Deadline</th>
              <th>Days left</th>
              <th class="right">Estimated value</th>
              <th>Sector</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody><!-- rows injected here --></tbody>
        </table>
      </div>
      <p class="muted" id="liveCount" style="margin-top:.5rem"></p>
    </div>
  </div>

  <!-- NEW: FRAMEWORKS TAB CONTENT -->
  <div class="tab-content" id="frameworks">
    <div class="live-wrap">
      <div class="live-header">
        <h2 class="live-title">Frameworks</h2>
        <div class="last-updated">Last refreshed: <span id="fw-last-refreshed">—</span></div>
      </div>
      <!-- The Frameworks table + Bid Analyser wizard will render here -->
      <div id="frameworks-root"></div>
    </div>
  </div>

  <script>
    /* ---------- Tab wiring ---------- */
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');

        if (tab.dataset.tab === 'live') {
          if (!document.getElementById('liveTable').dataset.loaded) {
            loadLive();
          }
        }
        // Frameworks tab doesn't need lazy-init here; its JS checks for #frameworks-root before running.
      });
    });

    /* ---------- Live data + filters ---------- */
    let allItems = [];
    let activeKey = 'all'; // 'all' | sector keys

    const FILTERS = [
      { key:'all',           label:'All' },
      { key:'aviation',      label:'Aviation' },
      { key:'utilities',     label:'Utilities' },
      { key:'rail',          label:'Rail' },
      { key:'highways',      label:'Highways' },
      { key:'maritime',      label:'Maritime' },
      { key:'infrastructure',label:'Infrastructure' },
    ];

    async function loadLive() {
      const tbody = document.querySelector('#liveTable tbody');
      const errEl = document.getElementById('liveError');
      const updatedEl = document.getElementById('lastUpdated');
      const countEl = document.getElementById('liveCount');

      errEl.style.display = 'none'; errEl.textContent = '';
      tbody.innerHTML = ''; countEl.textContent = '';

      try {
        const res = await fetch('/.netlify/functions/latest', { cache: 'no-store' });
        if (!res.ok) throw new Error(`latest returned ${res.status}`);
        const data = await res.json();

        updatedEl.textContent = `Last updated: ${formatDateTime(data.updatedAt)}`;
        allItems = Array.isArray(data.items) ? data.items.map(normalizeSector) : [];

        // build filter bar (with counts)
        buildFilters();

        // initial render
        applyFilter();
        document.getElementById('liveTable').dataset.loaded = '1';
      } catch (e) {
        errEl.textContent = `Error: ${e.message}`;
        errEl.style.display = 'block';
      }
    }

    function buildFilters(){
      const bar = document.getElementById('filterBar');
      const counts = countBySector(allItems);
      bar.innerHTML = FILTERS.map(f => {
        const c = f.key === 'all' ? allItems.length : (counts[f.key] || 0);
        const active = f.key === activeKey ? 'active' : '';
        return `<span class="filter-pill ${active}" data-key="${f.key}">${f.label} (${c})</span>`;
      }).join('');
      bar.querySelectorAll('.filter-pill').forEach(pill=>{
        pill.addEventListener('click', ()=>{
          activeKey = pill.dataset.key;
          bar.querySelectorAll('.filter-pill').forEach(el=>el.classList.toggle('active', el===pill));
          applyFilter();
        });
      });
    }

    function applyFilter(){
      const tbody = document.querySelector('#liveTable tbody');
      const countEl = document.getElementById('liveCount');

      const filtered = activeKey === 'all'
        ? allItems
        : allItems.filter(it => (it._sectorKey || '') === activeKey);

      tbody.innerHTML = filtered.map(renderRow).join('');
      countEl.textContent = `${filtered.length} opportunities`;
    }

    function countBySector(items){
      const m = {};
      for (const it of items){
        const k = it._sectorKey || 'infrastructure';
        m[k] = (m[k]||0)+1;
      }
      return m;
    }

    /* ---------- Rendering ---------- */
    function renderRow(it) {
      const title = esc(it.title || 'Untitled');
      const buyer = esc(it.organisation || '');
      const region = esc(it.region || '');
      const url = it.url ? esc(it.url) : '#';

      const deadlineISO = it.deadline || '';
      const deadlineTxt = deadlineISO ? formatDateTime(deadlineISO) : '—';
      const days = deadlineISO ? daysLeft(deadlineISO) : null;
      const daysTxt = days === null ? '—' : (days >= 0 ? `${days} day${days===1?'':'s'} left` : 'Closed');

      const valueLow = num(it.valueLow);
      const valueHigh = num(it.valueHigh);
      const valueTxt =
        valueLow === null && valueHigh === null ? '—'
        : valueLow !== null && valueHigh !== null ? `${gbp(valueLow)} – ${gbp(valueHigh)}`
        : gbp(valueLow ?? valueHigh);

      const sectorKey = it._sectorKey || '';
      const sectorLabel = sectorKey ? cap(sectorKey) : '—';

      const source = esc(it.source || '—');

      return `
        <tr>
          <td><a class="title-link" href="${url}" target="_blank" rel="noopener">${title}</a></td>
          <td>${buyer || '—'}</td>
          <td>${region || '—'}</td>
          <td>${deadlineTxt}</td>
          <td>${daysTxt}</td>
          <td class="right">${valueTxt}</td>
          <td><span class="pill ${sectorKey}">${sectorLabel}</span></td>
          <td>${source}</td>
        </tr>
      `;
    }

    /* ---------- Helpers ---------- */
    function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
    function num(x){ const n = Number(x); return Number.isFinite(n) ? n : null; }
    function gbp(n){
      try { return new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP',maximumFractionDigits:0}).format(n); }
      catch{ return `£${Math.round(n).toLocaleString('en-GB')}`; }
    }
    function formatDateTime(iso){
      const d = new Date(iso);
      if (isNaN(d)) return '—';
      const pad = v=>String(v).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function daysLeft(iso){
      const d = new Date(iso);
      if (isNaN(d)) return null;
      const ms = d - new Date();
      return Math.ceil(ms / (1000*60*60*24));
    }

    // Normalize/derive a consistent sector key for filtering
    function normalizeSector(it){
      const raw = (it.sector || '').toString().toLowerCase();
      let key = '';
      // direct matches
      if (/aviation/.test(raw)) key = 'aviation';
      else if (/utilit(y|ies)/.test(raw)) key = 'utilities';
      else if (/rail/.test(raw)) key = 'rail';
      else if (/highway|road/.test(raw)) key = 'highways';
      else if (/maritime|port|harbour|harbor/.test(raw)) key = 'maritime';
      else if (/infrastructure/.test(raw)) key = 'infrastructure';

      // if not provided, infer from title/org
      if (!key){
        const hay = `${(it.title||'')} ${(it.organisation||'')}`.toLowerCase();
        if (/airport|airfield|airside|aviation/.test(hay)) key = 'aviation';
        else if (/water|gas|electric|utilities|utility|sewer|wastewater/.test(hay)) key = 'utilities';
        else if (/rail|rolling stock|station|track/.test(hay)) key = 'rail';
        else if (/highway|roads?\b|junction|carriageway/.test(hay)) key = 'highways';
        else if (/port|harbour|harbor|dock|maritime|ferry/.test(hay)) key = 'maritime';
        else key = 'infrastructure'; // sensible default bucket
      }
      it._sectorKey = key;
      return it;
    }
  </script>

  <!-- NEW: Frameworks assets (table + analyser + export) -->
  <link rel="stylesheet" href="assets/css/frameworks.css">
  <script src="assets/js/frameworks.js" defer></script>
</body>
</html>
